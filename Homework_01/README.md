# Паттерны декомпозиции микросервисов

**Собственный кейс:** Созднание BI-платформы для автоматизации доставки данных до Stage-слоя DWH. 

BI-департамент подготавливает витрины данных для коллег из смежных департаментов. Источниками данных для витрин являются компоненты продуктовых команд компании, в качестве основного транспорта выступает Kafka.

Типовой сценарий - просмотр целевых показателей в дашборде после запуска нового проекта.  

Данные для витрин хранятся в DWH на реляционной СУБД. DWH разбито на слои (RAW -> Stage -> Operational Data Store -> Common Data Mart -> Product Data Mart).

Для разработки новой витрины может потребоваться разбор нового топика или добавление новых полей в существующий топик, с организацией проброса данных по слоям посредством ETL-процессов. 

Т.к. в свое время было проведено разделение компонентов на "микросервисы", этот процесс может затянуться из-за большого количества рутинных действий со стороны разработчиков в нескольких репозиториях. Добавляем к этому вероятность человеческих ошибок, ревью, тестирование и прочие накладные расходы.

Поток данных довольно большой, при этом важна полнота - нельзя потерять ни одной транзакции.

## 1. Пользовательские сценарии в свободном формате

**UC-1:** Просмотр актуального состояния разбора топиков

Разработчик получает информацию от разбираемых в настоящее время топиков Kafka.

**UC-2:** Разбор нового топика

Разработчик запускает разбор данных из топика в реляционные таблицы RAW-слоя БД в соответствии с его спецификацией.

**UC-3:** Изменение набора разбираемых атрибутов

Разработчик инициирует модификацию структуры таблиц БД и кода для разбора сообщений из топика Kafka. 

**UC-4:** Архивирование исходных сообщений топика

Разработчик запускает архивирование (перенос данных) из RAW-слоя в БД архива. 

**UC-5:** Нотификация об ошибках при разборе

Разработчик получает уведомление о появлении ошибок в процессе разбора сообщений из топика Kafka 

**UC-6:** Остановка разбора топика

Разработчик останавливает разбор сообщений из указанного топика

**UC-7:** Запуск приостановленного разбора топика

Разработчик запускает ранее приостановленный разбор сообщений из указанного топика

**UC-8:** Запуск ETL-процесса отправки данных из RAW в Stage слой DWH

Разработчик запускает процесс передачи данных по топику из RAW в Stage слой DWHа


## 2. Общая схема взаимодействия сервисов в свободном формате

![C2](img/C2.png?raw=true "C2")


## 3. Назначение сервисов и их зоны ответственности в свободном формате

**bi-platform-core-service** - центральный управляющий сервис, который является шлюзом для обработки запросов от пользователей и занимается маршрутизацией задач. Помимо этого, он отвечает за работу со спецификациями. 

**bi-platform-kafka-service** - Consumer сообщений из топиков Kafka. Сохраняет информацию на RAW-слой DWH. Предполагается, что этот сервис будет отвечать за запуск и работу множества worker'ов в Kubernates.

**bi-platform-etl-service** - реализует ETL-процессы переноса данных из raw → stage и raw → archive, с преобразованием json в реляционный вид, либо копирование 1 к 1. Предполагается возможность запуска в Kubernates с возможностью добавления worker'ов.

## 4. Контракты взаимодействия сервисов друг с другом в свободном формате

**bi-platform-core-service:**

* GET /api/v1/availableSpecifications
* GET /api/v1/specificationDetails/{id}
* POST /api/v1/parseSpecification/{id}
* POST /api/v1/topics/deploy {topic_ids}
* GET /api/v1/topics/run/{id}
* GET /api/v1/topics/stop/{id}
* GET /api/v1/topics/list/

**bi-platform-kafka-service:**

* POST /api/v1/deploy {config}
* POST /api/v1/updateSchema {id, config}
* GET /api/v1/run/{id}
* GET /api/v1/stop/{id}
* GET /api/v1/status/{id}

**bi-platform-etl-service:**

* POST /api/v1/deploy {config}
* POST /api/v1/updateModel {id, config}
* GET /api/v1/run/{id}
* GET /api/v1/stop/{id}
* GET /api/v1/status/{id}